<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Activitat - Competició IMPULSA</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            blau: '#1e3a8a',
            taronja: '#f59e0b',
            gris: '#f3f4f6',
            futur: '#0f172a'
          }
        }
      }
    }
  </script>
</head>
<body class="min-h-screen text-blau font-sans relative overflow-hidden">
  <div style="position:absolute;inset:0;z-index:-10;width:100vw;height:100vh;
    background: radial-gradient(circle at 60% 40%, #1e3a8a 0%, #0f172a 60%, #000 100%);
    opacity:0.9;"></div>

  <nav class="bg-futur bg-opacity-90 shadow-lg fixed w-full z-50" aria-label="Navegació principal">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="index.html" class="flex items-center gap-2">
        <img src="logo_impulsa_general.png" alt="Logo IMPULSA" class="w-10 h-10" />
        <span class="text-taronja font-bold text-xl tracking-wide">IMPULSA</span>
      </a>
      <ul class="flex space-x-6 text-white">
        <li><a href="index.html" class="hover:text-taronja transition-all">Inici</a></li>
        <li><a href="programa.html" class="hover:text-taronja transition-all">Programa</a></li>
        <li><a href="impulsa+45.html" class="hover:text-taronja transition-all">Impulsa+45</a></li>
        <li><a href="colaboracio.html" class="hover:text-taronja transition-all">Col·laboració</a></li>
        <li><a href="contacte.html" class="hover:text-taronja transition-all">Contacte</a></li>
        <li><a href="activitat.html" class="hover:text-taronja transition-all font-bold">Activitat</a></li>
      </ul>
    </div>
  </nav>

  <main class="max-w-5xl mx-auto px-4 pt-40 pb-20 pb-[300px]">
    <section id="activitat" aria-label="Competició d'Activitat" class="mb-16">
      <h2 class="text-3xl font-bold mb-8 text-white text-center drop-shadow">Competició IMPULSA: Desafia el teu Enginy!</h2>

      <!-- Afegeix aquí els components d'interfície de rol -->
      <div id="roleSelection" class="text-center text-white space-y-4">
        <h3 class="text-2xl font-bold mb-4">Escull el teu rol:</h3>
        <button id="hostBtn" class="bg-blau text-white px-6 py-2 rounded hover:bg-taronja">Soc l'Host</button>
        <button id="participantBtn" class="bg-blau text-white px-6 py-2 rounded hover:bg-taronja">Soc Participant</button>
      </div>

      <div id="hostInterface" class="hidden mt-8 text-white text-center">
        <button id="generateCodeBtn" class="bg-taronja text-blau px-6 py-2 rounded hover:bg-white">Generar Codi</button>
        <div id="activityCodeDisplay" class="hidden mt-4">
          <p>El teu codi és: <span id="generatedCode" class="text-2xl font-bold text-taronja"></span></p>
        </div>
        <div id="hostResultsContainer" class="host-results-display hidden mt-8">
          <h3 class="text-2xl font-bold mb-4">Resultats dels Participants</h3>
          <ul id="participantsList" class="text-left max-h-60 overflow-y-auto px-4"></ul>
          <button id="revealWinnerBtn" class="bg-taronja text-blau font-semibold px-6 py-2 rounded-full mt-6 hover:bg-blau hover:text-white">Revelar Guanyador</button>
          <div id="winnerDisplay" class="winner-message hidden mt-4"></div>
        </div>
      </div>

      <div id="participantInterface" class="hidden mt-8 text-white text-center">
        <input type="text" id="participantName" placeholder="El teu nom" class="mb-2 p-2 rounded text-black">
        <input type="text" id="activityCodeInput" placeholder="Codi d'activitat" class="mb-2 p-2 rounded text-black">
        <button id="startActivityBtn" class="bg-taronja text-blau px-6 py-2 rounded hover:bg-white">Començar</button>
      </div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, setDoc, getDocs, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import confetti from 'https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAzJg8lRvOqDlqTSM-hg8rnc3ATL7inXzk",
      authDomain: "impulsacompeticio.firebaseapp.com",
      projectId: "impulsacompeticio",
      storageBucket: "impulsacompeticio.appspot.com",
      messagingSenderId: "895840795245",
      appId: "1:895840795245:web:86931b9ea2f935ccc71d64"
    };

    const fanfareAudio = new Audio('fanfare.mp3');
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const hostBtn = document.getElementById('hostBtn');
    const participantBtn = document.getElementById('participantBtn');
    const hostInterface = document.getElementById('hostInterface');
    const participantInterface = document.getElementById('participantInterface');
    const roleSelection = document.getElementById('roleSelection');
    const generateCodeBtn = document.getElementById('generateCodeBtn');
    const generatedCodeSpan = document.getElementById('generatedCode');
    const activityCodeDisplay = document.getElementById('activityCodeDisplay');
    const hostResultsContainer = document.getElementById('hostResultsContainer');
    const participantsList = document.getElementById('participantsList');
    const revealWinnerBtn = document.getElementById('revealWinnerBtn');
    const winnerDisplay = document.getElementById('winnerDisplay');

    let currentActivityCode = '';

    hostBtn.addEventListener('click', () => {
      roleSelection.classList.add('hidden');
      hostInterface.classList.remove('hidden');
    });

    participantBtn.addEventListener('click', () => {
      roleSelection.classList.add('hidden');
      participantInterface.classList.remove('hidden');
    });

    generateCodeBtn.addEventListener('click', async () => {
      currentActivityCode = Math.random().toString(36).substring(2, 8).toUpperCase();
      generatedCodeSpan.innerText = currentActivityCode;
      activityCodeDisplay.classList.remove('hidden');
      hostResultsContainer.classList.remove('hidden');
      await setDoc(doc(db, "activities", currentActivityCode), { createdAt: new Date() });
      const q = collection(db, "activities", currentActivityCode, "participants");
      onSnapshot(q, (snapshot) => {
        participantsList.innerHTML = '';
        if (snapshot.empty) {
          participantsList.innerHTML = '<li>Esperant participants...</li>';
          return;
        }
        const participants = [];
        snapshot.forEach(doc => participants.push(doc.data()));
        participants.sort((a, b) => b.score - a.score);
        participants.forEach(p => {
          const li = document.createElement('li');
          li.innerHTML = `<strong>${p.name}</strong>: ${p.completed ? p.score + ' punts' : 'En curs...'}`;
          participantsList.appendChild(li);
        });
      });
    });

    revealWinnerBtn.addEventListener('click', async () => {
      if (!currentActivityCode) return;
      const ref = collection(db, "activities", currentActivityCode, "participants");
      const snapshot = await getDocs(ref);
      const participants = [];
      snapshot.forEach(doc => participants.push(doc.data()));
      participants.sort((a, b) => b.score - a.score);
      const winner = participants[0];
      if (winner) {
        winnerDisplay.innerText = `🏆 Guanyador: ${winner.name} amb ${winner.score} punts!`;
        winnerDisplay.classList.remove('hidden');
        confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
        fanfareAudio.play();
      } else {
        winnerDisplay.innerText = "No hi ha participants.";
        winnerDisplay.classList.remove('hidden');
      }
    });
  </script>

  <footer class="bg-futur text-white text-center py-6" aria-label="Peu de pàgina">
    <p>&copy; 2025 IMPULSA. Dissenyat amb propòsit i passió.</p>
  </footer>
</body>
</html>
